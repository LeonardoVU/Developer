!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],n):"object"==typeof exports?exports["babylonjs-serializers"]=n(require("babylonjs")):t.SERIALIZERS=n(t.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(t=>(()=>{"use strict";var n={597:n=>{n.exports=t}},e={};function a(t){var o=e[t];if(void 0!==o)return o.exports;var r=e[t]={exports:{}};return n[t](r,r.exports,a),r.exports}a.d=(t,n)=>{for(var e in n)a.o(n,e)&&!a.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:n[e]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),a.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var o={};a.d(o,{default:()=>S});var r={};a.r(r),a.d(r,{USDZExportAsync:()=>C});var i={};a.r(i),a.d(i,{USDZExportAsync:()=>C});var c=function(){return c=Object.assign||function(t){for(var n,e=1,a=arguments.length;e<a;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},c.apply(this,arguments)};Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var s=a(597),u=s.Matrix.Compose(new s.Vector3(-1,1,1),s.Quaternion.Identity(),s.Vector3.Zero());function l(t,n){if(!(t instanceof s.TransformNode))return!1;if(n){if(!t.getWorldMatrix().equalsWithEpsilon(s.Matrix.IdentityReadOnly,s.Epsilon))return!1}else if(!t.getWorldMatrix().multiplyToRef(u,s.TmpVectors.Matrix[0]).equalsWithEpsilon(s.Matrix.IdentityReadOnly,s.Epsilon))return!1;return!(t instanceof s.AbstractMesh&&t.geometry)}function p(t,n,e){void 0===e&&(e=3);for(var a=[],o=0;o<t.length/e;o++){var r=t[o*e],i=t[o*e+1],c=t[o*e+2];a.push("(".concat(r.toPrecision(n.precision),", ").concat(i.toPrecision(n.precision),", ").concat(c.toPrecision(n.precision),")"))}return a.join(", ")}function f(t,n){for(var e=[],a=0;a<t.length/2;a++){var o=t[2*a],r=t[2*a+1];e.push("(".concat(o.toPrecision(n.precision),", ").concat((1-r).toPrecision(n.precision),")"))}return e.join(", ")}function d(t,n){var e=function(t,n){var e=t.getVerticesData(s.VertexBuffer.PositionKind),a=t.getVerticesData(s.VertexBuffer.NormalKind);if(e&&a)return'\n\tdef Mesh "'.concat("Geometry",'"\n\t{\n\t\tint[] faceVertexCounts = [').concat(function(t){var n,e=(null===(n=t.getIndices())||void 0===n?void 0:n.length)?t.getTotalIndices():t.getTotalVertices();return Array(e/3).fill(3).join(", ")}(t),"]\n\t\tint[] faceVertexIndices = [").concat(function(t){var n=t.getIndices(),e=[];if(null!==n)for(var a=0;a<n.length;a++)e.push(n[a]);else{var o=t.getTotalVertices();for(a=0;a<o;a++)e.push(a)}return e.join(", ")}(t),"]\n\t\tnormal3f[] normals = [").concat(p(a,n),'] (\n\t\t\tinterpolation = "vertex"\n\t\t)\n\t\tpoint3f[] points = [').concat(p(e,n),"]\n        ").concat(function(t,n){for(var e="",a=0;a<4;a++){var o=a>0?a:"",r=t.getVerticesData(s.VertexBuffer.UVKind+(o?o+1:""));r&&(e+="\n\t\ttexCoord2f[] primvars:st".concat(o," = [").concat(f(r,n),'] (\n\t\t\tinterpolation = "vertex"\n\t\t)'))}var i=t.getVerticesData(s.VertexBuffer.ColorKind);return i&&(e+="\n\tcolor3f[] primvars:displayColor = [".concat(p(i,n,i.length/t.getTotalVertices()),'] (\n\t\tinterpolation = "vertex"\n\t\t)')),e}(t,n),'\n\t\tuniform token subdivisionScheme = "none"\n\t}\n')}(t,n);return'\n        def "Geometry"\n        {\n        '.concat(e,"\n        }\n        ")}function h(t){var n='#usda 1.0\n    (\n        customLayerData = {\n            string creator = "Babylon.js USDZExportAsync"\n        }\n        defaultPrim = "Root"\n        metersPerUnit = 1\n        upAxis = "Y"\n    )';return n+=t,fflate.strToU8(n)}function m(t){var n=t.m;return"( ".concat(g(n,0),", ").concat(g(n,4),", ").concat(g(n,8),", ").concat(g(n,12)," )")}function g(t,n){return"(".concat(t[n+0],", ").concat(t[n+1],", ").concat(t[n+2],", ").concat(t[n+3],")")}function M(t){var n="Object_"+t.uniqueId,e=function(t){var n=t.getWorldMatrix().clone(),e=t.getScene().useRightHandedSystem;if(!e)for(var a=t.parent;a;){if(l(a,e)){n.multiplyToRef(a.getWorldMatrix().invert(),n);break}a=a.parent}return n.determinant()<0&&s.Tools.Warn("Exporting mesh ".concat(t.name," with negative scale. Result may look incorrect in destination engine.")),n}(t),a=m(e);return'def Xform "'.concat(n,'" (\n\tprepend references = @./geometries/Geometry_').concat(t.geometry.uniqueId,'.usda@</Geometry>\n\tprepend apiSchemas = ["MaterialBindingAPI"]\n)\n{\n\tmatrix4d xformOp:transform = ').concat(a,'\n\tuniform token[] xformOpOrder = ["xformOp:transform"]\t\n\n    rel material:binding = </Materials/Material_').concat(t.material.uniqueId,">\n}\n\n")}function v(t){switch(t){case s.Constants.TEXTURE_CLAMP_ADDRESSMODE:return"clamp";case s.Constants.TEXTURE_MIRROR_ADDRESSMODE:return"mirror";case s.Constants.TEXTURE_WRAP_ADDRESSMODE:default:return"repeat"}}function y(t){return"(".concat(t.x,", ").concat(t.y,")")}function x(t){return"(".concat(t.r,", ").concat(t.g,", ").concat(t.b,")")}function b(t,n,e,a,o,r){var i=t.getInternalTexture().uniqueId+"_"+t.invertY;o[i]=t;var c=t.coordinatesIndex>0?"st"+t.coordinatesIndex:"st",u=new s.Vector2(t.uScale,t.vScale),l=new s.Vector2(t.uOffset,t.vOffset),p=t.wAng,f=Math.sin(p),d=Math.cos(p);return l.y=1-l.y-u.y,l.x+=f*u.x,l.y+=(1-d)*u.y,'\n    def Shader "PrimvarReader_'.concat(e,'"\n    {\n        uniform token info:id = "UsdPrimvarReader_float2"\n        float2 inputs:fallback = (0.0, 0.0)\n        token inputs:varname = "').concat(c,'"\n        float2 outputs:result\n    }\n\n    def Shader "Transform2d_').concat(e,'"\n    {\n        uniform token info:id = "UsdTransform2d"\n        token inputs:in.connect = </Materials/Material_').concat(n.uniqueId,"/PrimvarReader_").concat(e,".outputs:result>\n        float inputs:rotation = ").concat((p*(180/Math.PI)).toFixed(r.precision),"\n        float2 inputs:scale = ").concat(y(u),"\n        float2 inputs:translation = ").concat(y(l),'\n        float2 outputs:result\n    }\n\n    def Shader "Texture_').concat(t.uniqueId,"_").concat(e,'"\n    {\n        uniform token info:id = "UsdUVTexture"\n        asset inputs:file = @textures/Texture_').concat(i,".png@\n        float2 inputs:st.connect = </Materials/Material_").concat(n.uniqueId,"/Transform2d_").concat(e,".outputs:result>\n        ").concat(a?"float4 inputs:scale = "+function(t){return"(".concat(t.r,", ").concat(t.g,", ").concat(t.b,", 1.0)")}(a):"",'\n        token inputs:sourceColorSpace = "').concat(t.gammaSpace?"raw":"sRGB",'"\n        token inputs:wrapS = "').concat(v(t.wrapU),'"\n        token inputs:wrapT = "').concat(v(t.wrapV),'"\n        float outputs:r\n        float outputs:g\n        float outputs:b\n        float3 outputs:rgb\n        ').concat(n.needAlphaBlending()?"float outputs:a":"","\n    }")}function _(t,n,e){var a="\t\t\t",o=[],r=[],i=function(t){var n,e,a={diffuseMap:null,diffuse:null,alphaCutOff:0,emissiveMap:null,emissive:null,normalMap:null,roughnessMap:null,roughnessChannel:"a",roughness:0,metalnessMap:null,metalnessChannel:"r",metalness:0,aoMap:null,aoMapChannel:"rgb",aoMapIntensity:0,alphaMap:null,ior:1,clearCoatEnabled:!1,clearCoat:0,clearCoatMap:null,clearCoatRoughness:0,clearCoatRoughnessMap:null};return t instanceof s.StandardMaterial?c(c({},a),{diffuseMap:t.diffuseTexture,diffuse:t.diffuseColor,alphaCutOff:t.alphaCutOff,emissiveMap:t.emissiveTexture,emissive:t.emissiveColor,roughness:1,alphaMap:t.opacityTexture}):t instanceof s.PBRBaseMaterial?c(c({},a),{diffuseMap:t._albedoTexture,diffuse:t._albedoColor,alphaCutOff:t._alphaCutOff,emissiveMap:t._emissiveTexture,emissive:t._emissiveColor,normalMap:t._bumpTexture,roughnessMap:t._metallicTexture,roughnessChannel:t._useRoughnessFromMetallicTextureAlpha?"a":"g",roughness:null!==(n=t._roughness)&&void 0!==n?n:1,metalnessMap:t._metallicTexture,metalnessChannel:t._useMetallnessFromMetallicTextureBlue?"b":"r",metalness:null!==(e=t._metallic)&&void 0!==e?e:0,aoMap:t._ambientTexture,aoMapChannel:t._useAmbientInGrayScale?"r":"rgb",aoMapIntensity:t._ambientTextureStrength,alphaMap:t._opacityTexture,ior:t.subSurface.indexOfRefraction,clearCoatEnabled:t.clearCoat.isEnabled,clearCoat:t.clearCoat.intensity,clearCoatMap:t.clearCoat.texture,clearCoatRoughness:t.clearCoat.roughness,clearCoatRoughnessMap:t.clearCoat.useRoughnessFromMainTexture?t.clearCoat.texture:t.clearCoat.textureRoughness}):a}(t),u=i.diffuseMap,l=i.diffuse,p=i.alphaCutOff,f=i.emissiveMap,d=i.emissive,h=i.normalMap,m=i.roughnessMap,g=i.roughnessChannel,M=i.roughness,v=i.metalnessMap,y=i.metalnessChannel,_=i.metalness,C=i.aoMap,T=i.aoMapChannel,I=i.aoMapIntensity,S=i.alphaMap,R=i.ior,w=i.clearCoatEnabled,O=i.clearCoat,A=i.clearCoatMap,P=i.clearCoatRoughness,q=i.clearCoatRoughnessMap;return null!==u?(o.push("".concat(a,"color3f inputs:diffuseColor.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(u.uniqueId,"_diffuse.outputs:rgb>")),t.needAlphaBlending()?o.push("".concat(a,"float inputs:opacity.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(u.uniqueId,"_diffuse.outputs:a>")):t.needAlphaTesting()&&(o.push("".concat(a,"float inputs:opacity.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(u.uniqueId,"_diffuse.outputs:a>")),o.push("".concat(a,"float inputs:opacityThreshold = ").concat(p))),r.push(b(u,t,"diffuse",l,n,e))):o.push("".concat(a,"color3f inputs:diffuseColor = ").concat(x(l||s.Color3.White()))),null!==f?(o.push("".concat(a,"color3f inputs:emissiveColor.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(f.uniqueId,"_emissive.outputs:rgb>")),r.push(b(f,t,"emissive",d,n,e))):d&&d.toLuminance()>0&&o.push("".concat(a,"color3f inputs:emissiveColor = ").concat(x(d))),null!==h&&(o.push("".concat(a,"normal3f inputs:normal.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(h.uniqueId,"_normal.outputs:rgb>")),r.push(b(h,t,"normal",null,n,e))),null!==C&&(o.push("".concat(a,"float inputs:occlusion.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(C.uniqueId,"_occlusion.outputs:").concat(T,">")),r.push(b(C,t,"occlusion",new s.Color3(I,I,I),n,e))),null!==m?(o.push("".concat(a,"float inputs:roughness.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(m.uniqueId,"_roughness.outputs:").concat(g,">")),r.push(b(m,t,"roughness",new s.Color3(M,M,M),n,e))):o.push("".concat(a,"float inputs:roughness = ").concat(M)),null!==v?(o.push("".concat(a,"float inputs:metallic.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(v.uniqueId,"_metallic.outputs:").concat(y,">")),r.push(b(v,t,"metallic",new s.Color3(_,_,_),n,e))):o.push("".concat(a,"float inputs:metallic = ").concat(_)),null!==S?(o.push("".concat(a,"float inputs:opacity.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(S.uniqueId,"_opacity.outputs:r>")),o.push("".concat(a,"float inputs:opacityThreshold = 0.0001")),r.push(b(S,t,"opacity",null,n,e))):o.push("".concat(a,"float inputs:opacity = ").concat(t.alpha)),w&&(null!==A?(o.push("".concat(a,"float inputs:clearcoat.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(A.uniqueId,"_clearcoat.outputs:r>")),r.push(b(A,t,"clearcoat",new s.Color3(O,O,O),n,e))):o.push("".concat(a,"float inputs:clearcoat = ").concat(O)),null!==q?(o.push("".concat(a,"float inputs:clearcoatRoughness.connect = </Materials/Material_").concat(t.uniqueId,"/Texture_").concat(q.uniqueId,"_clearcoatRoughness.outputs:g>")),r.push(b(q,t,"clearcoatRoughness",new s.Color3(P,P,P),n,e))):o.push("".concat(a,"float inputs:clearcoatRoughness = ").concat(P))),o.push("".concat(a,"float inputs:ior = ").concat(R)),'\n\tdef Material "Material_'.concat(t.uniqueId,'"\n\t{\n\t\tdef Shader "PreviewSurface"\n\t\t{\n\t\t\tuniform token info:id = "UsdPreviewSurface"\n').concat(o.join("\n"),"\n\t\t\tint inputs:useSpecularWorkflow = 0\n\t\t\ttoken outputs:surface\n\t\t}\n\n\t\ttoken outputs:surface.connect = </Materials/Material_").concat(t.uniqueId,"/PreviewSurface.outputs:surface>\n\n").concat(r.join("\n"),"\n\n\t}\n")}function C(t,n,e){return a=this,o=void 0,i=function(){var a,o,r,i,u,l,p,f,g,v,y,x,b,C,T,I,S,R,w,O,A,P,q,E,j,k,D,U;return function(t,n){var e,a,o,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=c(0),i.throw=c(1),i.return=c(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(s){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(r=0)),r;)try{if(e=1,a&&(o=2&c[0]?a.return:c[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,c[1])).done)return o;switch(a=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return r.label++,{value:c[1],done:!1};case 5:r.label++,a=c[1],c=[0];continue;case 7:c=r.ops.pop(),r.trys.pop();continue;default:if(!((o=(o=r.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){r=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){r.label=c[1];break}if(6===c[0]&&r.label<o[1]){r.label=o[1],o=c;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(c);break}o[2]&&r.ops.pop(),r.trys.pop();continue}c=n.call(t,r)}catch(t){c=[6,t],a=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}(this,(function(V){switch(V.label){case 0:return a=c({fflateUrl:"https://unpkg.com/fflate@0.8.2",includeAnchoringProperties:!0,anchoringType:"plane",planeAnchoringAlignment:"horizontal",modelFileName:"model.usda",precision:5,exportCamera:!1,cameraSensorWidth:35},n),"undefined"!=typeof fflate?[3,2]:[4,s.Tools.LoadScriptAsync(a.fflateUrl)];case 1:V.sent(),V.label=2;case 2:for((o={})[a.modelFileName]=null,r='#usda 1.0\n    (\n        customLayerData = {\n            string creator = "Babylon.js USDZExportAsync"\n        }\n        defaultPrim = "Root"\n        metersPerUnit = 1\n        upAxis = "Y"\n    )',r+=function(t){var n=!0===t.includeAnchoringProperties?'\n\t\ttoken preliminary:anchoring:type = "'.concat(t.anchoringType,'"\n\t\ttoken preliminary:planeAnchoring:alignment = "').concat(t.planeAnchoringAlignment,'"'):"";return'def Xform "Root"\n    {\n        def Scope "Scenes" (\n            kind = "sceneLibrary"\n        )\n        {\n            def Xform "Scene" (\n                customData = {\n                    bool preliminary_collidesWithEnvironment = 0\n                    string sceneName = "Scene"\n                }\n                sceneName = "Scene"\n            )\n            {'.concat(n,"\n            ")}(a),i={},u=0,l=t.meshes;u<l.length;u++)0!==(p=l[u]).getTotalVertices()&&(g=(f=p).geometry,(v=f.material)&&g&&(!e||e(f))&&(-1!==["StandardMaterial","PBRMaterial","PBRMetallicRoughnessMaterial"].indexOf(v.getClassName())?((y="geometries/Geometry_"+g.uniqueId+".usda")in o||(x=d(g,a),o[y]=h(x)),v.uniqueId in i||(i[v.uniqueId]=v),r+=M(f)):s.Tools.Warn("USDZExportAsync does not support this material type: "+v.getClassName())));for(I in t.activeCamera&&a.exportCamera&&(r+=function(t,n){var e="Camera_"+t.uniqueId,a=m(s.Matrix.RotationY(Math.PI).multiply(t.getWorldMatrix()));if(t.mode===s.Constants.ORTHOGRAPHIC_CAMERA)return'def Camera "'.concat(e,'"\n\t\t{\n\t\t\tmatrix4d xformOp:transform = ').concat(a,'\n\t\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\t\tfloat2 clippingRange = (').concat(t.minZ.toPrecision(n.precision),", ").concat(t.maxZ.toPrecision(n.precision),")\n\t\t\tfloat horizontalAperture = ").concat((10*(Math.abs(t.orthoLeft||1)+Math.abs(t.orthoRight||1))).toPrecision(n.precision),"\n\t\t\tfloat verticalAperture = ").concat((10*(Math.abs(t.orthoTop||1)+Math.abs(t.orthoBottom||1))).toPrecision(n.precision),'\n\t\t\ttoken projection = "orthographic"\n\t\t}\n\t\n\t');var o=t.getEngine().getAspectRatio(t),r=n.cameraSensorWidth||35;return'def Camera "'.concat(e,'"\n\t\t{\n\t\t\tmatrix4d xformOp:transform = ').concat(a,'\n\t\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\t\tfloat2 clippingRange = (').concat(t.minZ.toPrecision(n.precision),", ").concat(t.maxZ.toPrecision(n.precision),")\n\t\t\tfloat focalLength = ").concat((r/(2*Math.tan(.5*t.fov))).toPrecision(n.precision),'\n            token projection = "perspective"\n\t\t\tfloat horizontalAperture = ').concat((r*o).toPrecision(n.precision),"\n\t\t\tfloat verticalAperture = ").concat((r/o).toPrecision(n.precision),"            \n\t\t}\n\t\n\t")}(t.activeCamera,a)),r+="\n            }\n        }\n    }",r+=function(t,n,e){var a=[];for(var o in t){var r=t[o];a.push(_(r,n,e))}return'\n    def "Materials"\n{\n'.concat(a.join(""),"\n}\n\n")}(i,b={},a),o[a.modelFileName]=fflate.strToU8(r),T=[],C=b)T.push(I);S=0,V.label=3;case 3:return S<T.length?(I=T[S])in C?(w=b[R=I],O=w.getSize(),[4,w.readPixels()]):[3,6]:[3,7];case 4:if(!(A=V.sent()))throw new Error("Texture data is not available");return[4,s.DumpTools.DumpDataAsync(O.width,O.height,A,"image/png",void 0,!1,!0)];case 5:P=V.sent(),o["textures/Texture_".concat(R,".png")]=new Uint8Array(P).slice(),V.label=6;case 6:return S++,[3,3];case 7:for(E in q=0,o)(j=o[E])&&(k=34+E.length,4!=(D=63&(q+=k))&&(U=new Uint8Array(64-D),o[E]=[j,{extra:{12345:U}}]),q=j.length);return[2,fflate.zipSync(o,{level:0})]}}))},new((r=void 0)||(r=Promise))((function(t,n){function e(t){try{s(i.next(t))}catch(t){n(t)}}function c(t){try{s(i.throw(t))}catch(t){n(t)}}function s(n){var a;n.done?t(n.value):(a=n.value,a instanceof r?a:new r((function(t){t(a)}))).then(e,c)}s((i=i.apply(a,o||[])).next())}));var a,o,r,i}var T=void 0!==a.g?a.g:"undefined"!=typeof window?window:void 0;if(void 0!==T)for(var I in r)T.BABYLON[I]=r[I];const S=i;return o.default})()));
//# sourceMappingURL=babylon.usdzSerializer.min.js.map